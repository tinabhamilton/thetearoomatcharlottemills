if (self.CavalryLogger) { CavalryLogger.start_js(["Eff5J"]); }

__d('CavalryLoggerImpl',['Arbiter','Banzai','Bootloader','ImageTimingHelper','ISB','KillabyteProfilerConfig','NavigationTimingHelper','PageEvents','PageletEventConstsJS','PageletEventsHelper','PerfXLogger','ResourceTimingBootloaderHelper','ScriptPath','TimeSliceHelper','performance','performanceAbsoluteNow'],function a(b,c,d,e,f,g){if(c.__markCompiled)c.__markCompiled();var h=c('KillabyteProfilerConfig').htmlProfilerModule,i=c('KillabyteProfilerConfig').profilerModule,j='cavalry',k=['t_start','t_paint','t_cstart'],l=window.CavalryLogger;Object.assign(l.prototype,{initializeInstrumentation:function(){if(this.instrumentation_started)return;var m=this;c('Arbiter').subscribe('BigPipe/init',function(event,n){if(n.lid==m.lid&&n.arbiter){m.recordTTIEvent(n.arbiter);m.recordDisplayedEvent(n.arbiter);m.recordLoadedEvent(n.arbiter);m.recordPageletEventsTime(n.arbiter);}});c('Arbiter').subscribe(c('PageEvents').BIGPIPE_ONLOAD,function(event,n){if(b.bigPipe&&m.lid===b.bigPipe.lid)m.addPiggyback('cjs_factory_count_e2e',c.__getTotalFactories()).addPiggyback('cjs_compile_time_e2e',c.__getCompileTime()).addPiggyback('cjs_factory_time_e2e',c.__getFactoryTime());});m.addPiggyback('script_path',c('ScriptPath').getScriptPath());if(this.is_detailed_profiler)c('PageletEventsHelper').init();this.instrumentation_started=true;},recordTTIEvent:function(m){var n=this;m.subscribe('tti_bigpipe',function(event,o){if(o.lid==n.lid){if(o.metrics)for(var p in o.metrics)n.addPiggyback(p,o.metrics[p]);if(o.usageSnapshot)n.ttiUsageSnapshot=o.usageSnapshot;n.setTTIPhase(o.phase).measurePageLoad(true,o.ts);n.setAbsTimeStamp('t_bigpipe_tti',o.ts,true);}});},recordDisplayedEvent:function(m){var n=this;m.subscribe('all_pagelets_displayed',function(event,o){if(o.lid===n.lid){if(o.usageSnapshot)n.ddUsageSnapshot=o.usageSnapshot;n.setAbsTimeStamp('t_marker_all_pagelets_displayed',o.ts,true);}});},recordLoadedEvent:function(m){var n=this;m.subscribe('all_pagelets_loaded',function(event,o){if(o.lid===n.lid)n.setAbsTimeStamp('t_marker_bigpipe_e2e',o.ts,true);});},recordPageletEventsTime:function(m){if(this.is_detailed_profiler){var n=this;m.subscribe('pagelet_event',function(event,o){if(o.lid==n.lid){var p=o.id;n.events[p]=n.events[p]||{};n.events[p][o.event]=o.ts-window._cstart;if(o.event===c('PageletEventConstsJS').ARRIVE_END)n.events[p].phase=o.phase;}});}},setTTIPhase:function(m){this.addPiggyback('tti_phase',m);return this;},setTimeStamp:function(m,n,o,p){this.mark(m);var q=this.values.t_cstart||this.values.t_start,r=p?q+p:c('performanceAbsoluteNow')();this.setValue(m,r,n,o);if(this.tti_event&&m==this.tti_event)this.measurePageLoad(n);return this;},setAbsTimeStamp:function(m,n,o,p){this.setValue(m,n,o,p);if(this.tti_event&&m==this.tti_event)this.measurePageLoad(o,n);return this;},logE2E:function(){var m={lid:this.lid,t_creport:c('performanceAbsoluteNow')(),cavalry_e2e:true};if(c('ISB').token)m.fb_isb=c('ISB').token;for(var n=0;n<k.length;n++)m[k[n]]=this.values[k[n]];c('Banzai').post(j,m,{signal:true,retry:false});this.e2eLogged=true;},log:function(){if(!this.e2eLogged)this.logE2E();var m={lid:this.lid};if(c('ISB').token)m.fb_isb=c('ISB').token;this.addPiggyback('pagelet_events',c('PageletEventsHelper').getMetrics(this.lid));this.setValue('client_pixel_ratio_10x',parseInt((window.devicePixelRatio||1)*10,10));this.moveBootloaderData();var n=babelHelpers['extends']({t_creport:c('performanceAbsoluteNow')()},m,this.values,this.piggy_values),o=window.__bodyWrapper;if(o.getCodeUsage&&i){if(!this.start||!this.e2e||!this.dd)throw new Error('Timestamps are missing in Cavalry. Please report '+'this to the Web Speed team');var p=i.findUsedCSSSelectors(document,i.getDocumentStylesheets(document)),q={js_calls:JSON.stringify(o.getCodeUsage()),css_selectors:JSON.stringify(p),bootloads:JSON.stringify(this.getBootloadsUntil(this.e2e))};if(h)q.html=JSON.stringify(h.getKillabyteHTMLData());var r=babelHelpers['extends']({},i.getDataForSnapshot(this.ddUsageSnapshot),{bootloads:JSON.stringify(this.getBootloadsUntil(this.dd))}),s={e2e:q,dd:r};if(this.ttiUsageSnapshot){if(!this.tti)throw new Error('tti timestamp should always be present if we have usage data');s.tti=babelHelpers['extends']({},i.getDataForSnapshot(this.ttiUsageSnapshot),{bootloads:JSON.stringify(this.getBootloadsUntil(this.tti))});}c('Arbiter').inform('cavalry_usage_data_collected',{usageData:s,lid:this.lid},c('Arbiter').BEHAVIOR_STATE);o.clearCodeUsage();}var t=c('PerfXLogger').getPayload(n.lid);if(t)this.logPerfXPiggybacks(n,t);c('Banzai').post(j,n,c('Banzai').VITAL);var u=this.values;this.values={};this.piggy_values={};for(var v=0;v<k.length;v++)this.values[k[v]]=u[k[v]];c('Arbiter').inform('cavalry_log_sent',n,c('Arbiter').BEHAVIOR_STATE);},logPerfXPiggybacks:function(m,n){m.perfx_page=n.perfx_page;m.perfx_page_type=n.perfx_page_type;m.perfx_tti=n.tti;m.perfx_e2e=n.e2e;},logPiggybacks:function(){this.moveBootloaderData();var m=babelHelpers['extends']({lid:this.lid},this.piggy_values);this.piggy_values={};c('Banzai').post(j,m,c('Banzai').VITAL);},moveBootloaderData:function(){if(this.log_resources)this.addPiggyback('resource_timing_bootloader',c('ResourceTimingBootloaderHelper').addBootloaderMetricsToResourceTimings(this.piggy_values.resource_timing_bootloader,this.bootloader_metrics,false,{}));},collectMetrics:function(m){if(!this.metric_collected||m){this.metric_collected=true;this.addPiggyback('tag',document.getElementsByTagName('*').length);this.addPiggyback('htmlsize_client',document.body.innerHTML.length);}},getBootloadsUntil:function(m){return Object.entries(c('Bootloader').getBootloadedComponents()).filter(function(n){var o=n[0],p=n[1];return p>=this.start&&p<=m;}.bind(this)).map(function(n){var o=n[0],p=n[1];return o;});},measurePageLoad:function(m,n){if(n){this.setAbsTimeStamp('t_tti',n,m);}else this.setTimeStamp('t_tti',m);this.collectMetrics(m);},collectBrowserTiming:function(m){if(c('performance').timing){this.start=c('performance').timing.navigationStart;this.tti=this.values.t_bigpipe_tti;this.dd=this.values.t_marker_all_pagelets_displayed;this.e2e=this.values.t_onload;var n=c('NavigationTimingHelper').getNavTimings();this.addPiggyback('navigation_timing',n);this.addPiggyback('time_slice',c('TimeSliceHelper').getMetrics(this.start,this.e2e,1,1));if(this.log_resources){this.addPiggyback('resource_timing_bootloader',c('ResourceTimingBootloaderHelper').getMetrics(0,this.lid,false));this.collectTTIAndE2EWithImages();}}},collectTimingForAsync:function(m,n){if(!n)return;if(c('performance').timing&&c('performance').getEntriesByName){var o=c('performance').getEntriesByName(n);if(o.length===0)return;this.start=c('performance').timing.navigationStart+o[0].startTime;this.tti=this.values.t_bigpipe_tti;this.e2e=this.values.t_onload;var p=c('NavigationTimingHelper').getAsyncRequestTimings(n);this.addPiggyback('navigation_timing',p);this.addPiggyback('time_slice',c('TimeSliceHelper').getMetrics(this.start,this.e2e,1,1));if(this.log_resources){this.addPiggyback('resource_timing_bootloader',c('ResourceTimingBootloaderHelper').getMetrics(o[0].startTime,this.lid,false));this.collectTTIAndE2EWithImages();}}},collectTTIAndE2EWithImages:function(){var m=c('performance').timing.navigationStart,n=this.values.t_bigpipe_tti,o=this.values.t_marker_bigpipe_e2e,p=c('ImageTimingHelper').getImageTimings(this.lid),q=c('ResourceTimingBootloaderHelper').getLastTTIAndE2EImageResponseEnds(n,o,p);if(!isNaN(q.TTI)&&q.TTI!==m)this.setAbsTimeStamp('t_tti_with_images',q.TTI);if(!isNaN(q.E2E)&&q.E2E!==m)this.setAbsTimeStamp('t_marker_bigpipe_e2e_with_images',q.E2E);},collectTiming:function(m,n,o){var p=['connectEnd','connectStart','domComplete','domContentLoadedEventEnd','domContentLoadedEventStart','domInteractive','domLoading','domainLookupEnd','domainLookupStart','fetchStart','loadEventEnd','loadEventStart','navigationStart','redirectEnd','redirectStart','requestStart','responseEnd','responseStart','secureConnectionStart','startTime','unloadEventEnd','unloadEventStart'];for(var q=0;q<p.length;q++){var r=p[q];if(n[r])this.setAbsTimeStamp(m+r,n[r]+o,true);}}});Object.assign(l,{startInstrumentation:function(){for(var m in l.instances){var n=l.instances[m];n.initializeInstrumentation();if('t_tti' in n.values)n.measurePageLoad(false,n.values.t_tti);}}});f.exports=l;},null);